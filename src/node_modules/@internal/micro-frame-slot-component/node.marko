import { getSource } from "../../../util/stream";

$ {
  const streamSource = getSource(input.from, out);
  const stream = streamSource.slot(input.slot);
  let finishLoading;
  const loadingPromise =
    input.loading && new Promise((res) => (finishLoading = res));
}
<div id=component.id class=input.class style=input.style data-slot=input.slot data-from=input.from>
  <macro|{ loaded }| name="wait">
    <await(stream.next())
      client-reorder=(input.clientReorder === "after-first-chunk" ? !!loaded : !!input.clientReorder)
      timeout=input.timeout
    >
      <@then|{ value, done }|>
        <if(!done)>
          $!{value}
          <wait loaded=true />
        </if>
        <else>
          $ finishLoading && finishLoading();
        </else>
      </@then>
      <@catch|e|>
        $ finishLoading && finishLoading();
        <script>(function(e){if(e)e.textContent=""})(document.getElementById(${JSON.stringify(component.id)}))</script>
        <${input.catch}(e)/>
      </@catch>
    </await>
  </macro>
  $ out.bf("@_", component, true);
  <if(stream)>
    <if(input.loading)>
      <await(loadingPromise) placeholder=input.loading client-reorder/>
    </if>
    <wait/>
  </if>
  $ out.ef();
</div>
